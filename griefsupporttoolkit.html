<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grief Support Toolkit</title>
<style>
  /* Reset and base */
  *, *::before, *::after {
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 0;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: #222;
    min-height: 100vh;
    display: flex; flex-direction: column;
    align-items: center;
    padding: 1rem;
    transition: background-color 0.5s ease, color 0.5s ease;
  }
  h1, h2, h3, h4 {
    margin: 0 0 0.5em 0;
    font-weight: 700;
    letter-spacing: 0.02em;
  }
  h1 {
    font-size: 2.4rem;
    color: #fff;
    text-shadow: 0 2px 5px rgba(0,0,0,0.3);
    margin-bottom: 0.25em;
  }
  p, label {
    line-height: 1.5;
  }
  button {
    cursor: pointer;
    border: none;
    border-radius: 8px;
    padding: 0.6em 1.2em;
    font-weight: 600;
    font-size: 1rem;
    background: linear-gradient(135deg, #5a67d8, #7b4bd1);
    color: white;
    box-shadow: 0 4px 10px rgba(123, 75, 209, 0.4);
    transition: background 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
    user-select: none;
  }
  button:hover, button:focus {
    background: linear-gradient(135deg, #7b4bd1, #5a67d8);
    box-shadow: 0 6px 14px rgba(123, 75, 209, 0.7);
    outline: none;
    transform: translateY(-2px);
  }
  button:active {
    transform: translateY(0);
  }

  /* Container */
  .container {
    max-width: 760px;
    width: 100%;
    background: rgba(255 255 255 / 0.95);
    border-radius: 12px;
    padding: 2rem 2.5rem 3rem;
    box-shadow: 0 12px 32px rgba(100, 85, 150, 0.25);
    margin-bottom: 2rem;
  }

  /* Section styles */
  section {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #d0d0d0;
  }
  section:last-child {
    border-bottom: none;
  }
  section h2 {
    color: #4a3db1;
    font-size: 1.8rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }
  section h2 .icon {
    font-size: 1.7rem;
  }

  /* Subtitle */
  .subtitle {
    color: #eee;
    font-style: italic;
    margin-bottom: 1.5rem;
  }

  /* Understanding Grief */
  #openGriefModal {
    background: #6f52f5;
    font-size: 1.1rem;
    padding: 0.75em 1.5em;
  }

  /* Coping Strategies */
  .coping-strategies {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: center;
  }
  .strategy-card {
    background: linear-gradient(135deg, #8e7de6, #6c54d1);
    color: white;
    width: 140px;
    height: 140px;
    border-radius: 14px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.2rem;
    text-align: center;
    box-shadow: 0 6px 14px rgba(109, 87, 194, 0.7);
    user-select: none;
    transition: background 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
  }
  .strategy-card:hover, .strategy-card:focus {
    background: linear-gradient(135deg, #a28bee, #8863d6);
    box-shadow: 0 10px 22px rgba(139, 111, 232, 0.9);
    outline: none;
    transform: translateY(-5px);
  }
  .strategy-card .emoji {
    font-size: 2.5rem;
    margin-bottom: 0.4rem;
  }

  /* Journaling */
  textarea {
    width: 100%;
    min-height: 110px;
    padding: 1rem;
    font-size: 1rem;
    border-radius: 8px;
    border: 2px solid #7b68ee;
    resize: vertical;
    font-family: inherit;
    transition: border-color 0.3s ease;
  }
  textarea:focus {
    outline: none;
    border-color: #4a3db1;
    box-shadow: 0 0 8px #4a3db1aa;
  }
  #saveJournalBtn {
    margin-top: 0.75rem;
    background: #5a4db1;
    width: 140px;
    text-align: center;
  }
  #saveJournalBtn:hover, #saveJournalBtn:focus {
    background: #764ba2;
  }
  #journalMessage {
    margin-top: 0.5rem;
    font-weight: 600;
    color: #4a3db1;
  }

  /* Mood Tracker */
  .mood-buttons {
    display: flex;
    justify-content: space-around;
    margin-bottom: 1rem;
  }
  .mood-btn {
    background: #7b68ee;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    font-size: 1.7rem;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 4px 12px rgba(123, 104, 238, 0.5);
    transition: background 0.3s ease;
  }
  .mood-btn:hover, .mood-btn:focus {
    background: #4a3db1;
    outline: none;
    transform: scale(1.15);
  }
  .progress-bar {
    width: 100%;
    height: 14px;
    background: #ddd;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 0.75rem;
  }
  .progress-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(135deg, #5a4db1, #7b68ee);
    transition: width 0.4s ease;
  }
  #moodMessage {
    font-weight: 600;
    text-align: center;
    font-size: 1.1rem;
    color: #4a3db1;
  }

  /* Emergency Support */
  .emergency-section p {
    margin: 0.3rem 0;
    font-size: 1.1rem;
  }
  .emergency-number {
    font-weight: 700;
    font-size: 1.5rem;
    color: #b52e31;
    margin-bottom: 0.5rem;
  }
  .emergency-section a {
    color: #b52e31;
    font-weight: 700;
    text-decoration: none;
    border-bottom: 2px solid transparent;
    transition: border-color 0.3s ease;
  }
  .emergency-section a:hover, .emergency-section a:focus {
    border-color: #b52e31;
    outline: none;
  }

  /* Modal base */
  .modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.65);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    padding: 1rem;
    overflow-y: auto;
  }
  .modal-overlay.active {
    display: flex;
  }
  .modal-content {
    background: white;
    border-radius: 12px;
    max-width: 480px;
    width: 100%;
    padding: 1.75rem 2rem;
    box-shadow: 0 12px 32px rgba(0,0,0,0.35);
    position: relative;
    animation: fadeInScale 0.25s ease forwards;
  }
  @keyframes fadeInScale {
    from {opacity: 0; transform: scale(0.9);}
    to {opacity: 1; transform: scale(1);}
  }
  .modal-content h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    color: #5a4db1;
  }
  .modal-close {
    position: absolute;
    top: 12px;
    right: 14px;
    background: transparent;
    font-size: 1.8rem;
    font-weight: 700;
    color: #666;
    border: none;
    cursor: pointer;
    user-select: none;
    transition: color 0.25s ease;
  }
  .modal-close:hover, .modal-close:focus {
    color: #4a3db1;
    outline: none;
  }
  .modal-body {
    font-size: 1rem;
    line-height: 1.5;
    color: #333;
  }
  .modal-body ul {
    margin-left: 1.25rem;
  }

  /* Breathing Modal circle animation */
  .breathing-circle {
    width: 120px;
    height: 120px;
    margin: 1rem auto 2rem;
    border-radius: 50%;
    background: linear-gradient(135deg, #6f52f5, #764ba2);
    animation: breatheCycle 16s ease-in-out infinite;
    box-shadow: 0 0 30px rgba(107,82,245,0.7);
  }
  @keyframes breatheCycle {
    0%, 100% { transform: scale(1); opacity: 1; }
    25% { transform: scale(1.3); opacity: 0.7; }
    50% { transform: scale(1); opacity: 1; }
    75% { transform: scale(0.7); opacity: 0.7; }
  }

  /* Analytics toggle */
  #showAnalytics {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 52px;
    height: 52px;
    font-size: 1.7rem;
    background: #5a4db1;
    border-radius: 50%;
    box-shadow: 0 6px 14px rgba(109, 87, 194, 0.8);
    color: white;
    border: none;
    cursor: pointer;
    user-select: none;
    transition: background 0.3s ease;
    z-index: 1100;
  }
  #showAnalytics:hover, #showAnalytics:focus {
    background: #764ba2;
    outline: none;
    transform: scale(1.1);
  }

  /* Analytics Panel */
  #analyticsPanel {
    position: fixed;
    bottom: 96px;
    right: 24px;
    max-width: 320px;
    width: 90vw;
    max-height: 400px;
    background: white;
    border-radius: 14px;
    box-shadow: 0 14px 38px rgba(0,0,0,0.4);
    padding: 1.2rem 1.5rem 1.8rem;
    display: none;
    flex-direction: column;
    z-index: 1101;
    overflow-y: auto;
  }
  #analyticsPanel h4 {
    margin-top: 0;
    margin-bottom: 0.75rem;
    color: #5a4db1;
    font-weight: 700;
  }
  #analyticsPanel p {
    margin: 0.3rem 0;
  }
  #strategyClicksList {
    padding-left: 1.2rem;
    margin-top: 0.4rem;
  }
  #strategyClicksList li {
    font-weight: 600;
    margin-bottom: 0.2rem;
  }
  #closeAnalytics {
    margin-top: 1rem;
    align-self: flex-end;
    background: #b52e31;
    color: white;
    width: 72px;
    padding: 0.4em 0.6em;
    font-weight: 700;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(181, 46, 49, 0.7);
  }
  #closeAnalytics:hover, #closeAnalytics:focus {
    background: #a3292a;
    outline: none;
  }

  /* Responsive */
  @media (max-width: 600px) {
    .container {
      padding: 1.5rem 1.5rem 2rem;
    }
    .coping-strategies {
      gap: 0.75rem;
    }
    .strategy-card {
      width: 120px;
      height: 120px;
      font-size: 1.05rem;
    }
    #analyticsPanel {
      bottom: 80px;
      right: 12px;
      max-width: 280px;
      width: 95vw;
      max-height: 360px;
      padding: 1rem 1rem 1.5rem;
    }
  }
</style>
</head>
<body>

<header>
  <h1>Grief Support Toolkit</h1>
  <p class="subtitle">Your companion for healing and understanding</p>
</header>

<div class="container" role="main" aria-label="Grief Support Toolkit content">

  <!-- Section 1: Understanding Grief -->
  <section aria-labelledby="section1-title">
    <h2 id="section1-title"><span class="icon" aria-hidden="true">💡</span>Understanding Grief</h2>
    <p>
      <button id="openGriefModal" aria-haspopup="dialog" aria-controls="modalOverlay" aria-expanded="false" aria-describedby="section1-desc">
        Learn More
      </button>
    </p>
    <p id="section1-desc" class="sr-only">Click to open a detailed explanation about grief.</p>
  </section>

  <!-- Section 2: Coping Strategies -->
  <section aria-labelledby="section2-title">
    <h2 id="section2-title"><span class="icon" aria-hidden="true">🛠️</span>Coping Strategies</h2>
    <div class="coping-strategies" role="list" aria-label="List of coping strategies">
      <button class="strategy-card" data-strategy="Breathing" role="listitem" aria-describedby="strategyBreathingDesc" tabindex="0">
        <span class="emoji" aria-hidden="true">🧘</span>Breathing
      </button>
      <button class="strategy-card" data-strategy="Journaling" role="listitem" aria-describedby="strategyJournalingDesc" tabindex="0">
        <span class="emoji" aria-hidden="true">📝</span>Journaling
      </button>
      <button class="strategy-card" data-strategy="Exercise" role="listitem" aria-describedby="strategyExerciseDesc" tabindex="0">
        <span class="emoji" aria-hidden="true">🏃‍♂️</span>Exercise
      </button>
      <button class="strategy-card" data-strategy="Connection" role="listitem" aria-describedby="strategyConnectionDesc" tabindex="0">
        <span class="emoji" aria-hidden="true">🤝</span>Connection
      </button>
      <button class="strategy-card" data-strategy="Mindfulness" role="listitem" aria-describedby="strategyMindfulnessDesc" tabindex="0">
        <span class="emoji" aria-hidden="true">🧠</span>Mindfulness
      </button>
      <button class="strategy-card" data-strategy="Help" role="listitem" aria-describedby="strategyHelpDesc" tabindex="0">
        <span class="emoji" aria-hidden="true">📞</span>Help
      </button>
    </div>
  </section>

  <!-- Section 3: Journaling -->
  <section aria-labelledby="section3-title">
    <h2 id="section3-title"><span class="icon" aria-hidden="true">📓</span>Journaling</h2>
    <label for="journalEntry" id="journalLabel">Write your thoughts here...</label>
    <textarea id="journalEntry" aria-labelledby="journalLabel" placeholder="Write your thoughts here..."></textarea>
    <button id="saveJournalBtn" aria-live="polite" aria-atomic="true">Save Entry</button>
    <p id="journalMessage" role="status" aria-live="polite" aria-atomic="true"></p>
  </section>

  <!-- Section 5: Mood Tracker -->
  <section aria-labelledby="section5-title">
    <h2 id="section5-title"><span class="icon" aria-hidden="true">😊</span>Mood Tracker</h2>
    <div class="mood-buttons" role="radiogroup" aria-label="Mood selection">
      <button class="mood-btn" data-mood="1" aria-label="Very Sad" role="radio" tabindex="0">😞</button>
      <button class="mood-btn" data-mood="2" aria-label="Sad" role="radio" tabindex="-1">😟</button>
      <button class="mood-btn" data-mood="3" aria-label="Neutral" role="radio" tabindex="-1">😐</button>
      <button class="mood-btn" data-mood="4" aria-label="Happy" role="radio" tabindex="-1">🙂</button>
      <button class="mood-btn" data-mood="5" aria-label="Very Happy" role="radio" tabindex="-1">😄</button>
    </div>
    <div class="progress-bar" aria-hidden="true">
      <div class="progress-fill"></div>
    </div>
    <p id="moodMessage" aria-live="polite" aria-atomic="true"></p>
  </section>

  <!-- Section 6: Emergency Support -->
  <section aria-labelledby="section6-title" class="emergency-section">
    <h2 id="section6-title"><span class="icon" aria-hidden="true">🚨</span>Emergency Support</h2>
    <p>If you or someone you know is in crisis, please reach out immediately:</p>
    <p class="emergency-number" tabindex="0" role="text">Canada Suicide Prevention Service (CSPS): <a href="tel:1-833-456-4566" rel="noopener noreferrer" target="_blank">1-833-456-4566</a></p>
    <p><a href="https://www.crisisservicescanada.ca/en/" target="_blank" rel="noopener noreferrer">Visit Crisis Services Canada</a></p>
  </section>

  <!-- Section 7: Resources -->
  <section aria-labelledby="section7-title">
    <h2 id="section7-title"><span class="icon" aria-hidden="true">📚</span>Additional Resources</h2>
    <ul>
      <li><a href="https://www.griefshare.org/" target="_blank" rel="noopener noreferrer">GriefShare Support Groups</a></li>
      <li><a href="https://www.psychologytoday.com/us/therapists/grief" target="_blank" rel="noopener noreferrer">Find a Grief Therapist (US)</a></li>
      <li><a href="https://www.cmha.ca/" target="_blank" rel="noopener noreferrer">Canadian Mental Health Association</a></li>
      <li><a href="https://www.ementalhealth.ca/" target="_blank" rel="noopener noreferrer">eMentalHealth.ca</a></li>
      <li><a href="https://www.bereavedfamilies.net/" target="_blank" rel="noopener noreferrer">Bereaved Families of Ontario</a></li>
    </ul>
  </section>

  <!-- Section 10: Support Contacts -->
  <section aria-labelledby="section10-title">
    <h2 id="section10-title"><span class="icon" aria-hidden="true">☎️</span>Support Contacts</h2>
    <ul>
      <li><a href="https://www.suicideprevention.ca/" target="_blank" rel="noopener noreferrer">Canadian Suicide Prevention Service</a></li>
      <li><a href="https://www.nimh.nih.gov/health/topics/coping-with-traumatic-events" target="_blank" rel="noopener noreferrer">US National Institute of Mental Health - Coping</a></li>
      <li><a href="https://suicidepreventionlifeline.org/" target="_blank" rel="noopener noreferrer">US Suicide Prevention Lifeline</a></li>
      <li><a href="https://www.samhsa.gov/find-help/national-helpline" target="_blank" rel="noopener noreferrer">SAMHSA National Helpline (US)</a></li>
    </ul>
  </section>

</div>

<!-- Understanding Grief Modal -->
<div id="modalOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalDesc" tabindex="-1">
  <div class="modal-content" role="document">
    <button class="modal-close" aria-label="Close modal">&times;</button>
    <h3 id="modalTitle">Understanding Grief</h3>
    <div id="modalDesc" class="modal-body">
      <p>Grief is a natural response to loss, involving a range of emotions including sadness, anger, confusion, and loneliness. Everyone experiences grief differently and there is no right or wrong way to grieve.</p>
      <p>It’s important to allow yourself to feel these emotions and seek support when needed. Grief can affect your mental, physical, and emotional well-being.</p>
      <p>Common stages include:</p>
      <ul>
        <li>Denial &amp; Isolation</li>
        <li>Anger</li>
        <li>Bargaining</li>
        <li>Depression</li>
        <li>Acceptance</li>
      </ul>
      <p>Remember, healing takes time. Be kind to yourself.</p>
    </div>
  </div>
</div>

<!-- Coping Strategy Modal -->
<div id="strategyModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="strategyModalTitle" aria-describedby="strategyModalDesc" tabindex="-1">
  <div class="modal-content" role="document">
    <button class="modal-close" aria-label="Close modal">&times;</button>
    <h3 id="strategyModalTitle"></h3>
    <div id="strategyModalDesc" class="modal-body"></div>
  </div>
</div>

<!-- Breathing Modal -->
<div id="breathingModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="breathingModalTitle" aria-describedby="breathingModalDesc" tabindex="-1">
  <div class="modal-content" role="document">
    <button class="modal-close" aria-label="Close modal">&times;</button>
    <h3 id="breathingModalTitle">Breathing Exercise</h3>
    <div id="breathingModalDesc" class="modal-body">
      <div class="breathing-circle" aria-hidden="true"></div>
      <p>Follow this simple breathing pattern:</p>
      <ol>
        <li>Breathe in slowly through your nose for 4 seconds.</li>
        <li>Hold your breath for 4 seconds.</li>
        <li>Exhale gently through your mouth for 4 seconds.</li>
        <li>Repeat several cycles until you feel calmer.</li>
      </ol>
    </div>
  </div>
</div>

<!-- Analytics Button -->
<button id="showAnalytics" title="Show Usage Analytics" aria-label="Show Usage Analytics">📊</button>

<!-- Analytics Panel -->
<div id="analyticsPanel" role="region" aria-live="polite" aria-label="Usage analytics panel" tabindex="0">
  <h4>Usage Analytics</h4>
  <p><strong>Most Viewed Section:</strong> <span id="mostViewedSection">None yet</span></p>
  <p><strong>Coping Strategy Clicks:</strong></p>
  <ul id="strategyClicksList" aria-live="polite" aria-atomic="true"></ul>
  <button id="closeAnalytics">Close</button>
</div>

<script>
(() => {
  'use strict';

  // Accessibility utility for trapping focus inside modal
  function trapFocus(element) {
    const focusableElementsString = 'a[href], area[href], input:not([disabled]):not([type="hidden"]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), iframe, object, embed, [tabindex="0"], [contenteditable]';
    const focusableElements = element.querySelectorAll(focusableElementsString);
    if (focusableElements.length === 0) return;

    const firstFocusable = focusableElements[0];
    const lastFocusable = focusableElements[focusableElements.length -1];

    function handleTab(e) {
      if (e.key === 'Tab' || e.keyCode === 9) {
        if (e.shiftKey) { // shift + tab
          if (document.activeElement === firstFocusable) {
            e.preventDefault();
            lastFocusable.focus();
          }
        } else { // tab
          if (document.activeElement === lastFocusable) {
            e.preventDefault();
            firstFocusable.focus();
          }
        }
      }
    }
    element.addEventListener('keydown', handleTab);
    return () => element.removeEventListener('keydown', handleTab);
  }

  // Modal controls
  function openModal(modal) {
    modal.classList.add('active');
    modal.setAttribute('aria-hidden', 'false');
    modal.querySelector('.modal-close').focus();
    const releaseFocusTrap = trapFocus(modal);
    return releaseFocusTrap;
  }
  function closeModal(modal, releaseFocusTrap, lastFocus) {
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden', 'true');
    if (releaseFocusTrap) releaseFocusTrap();
    if (lastFocus) lastFocus.focus();
  }

  // Elements
  const griefBtn = document.getElementById('openGriefModal');
  const griefModal = document.getElementById('modalOverlay');
  const griefCloseBtn = griefModal.querySelector('.modal-close');

  const strategyModal = document.getElementById('strategyModal');
  const strategyModalTitle = document.getElementById('strategyModalTitle');
  const strategyModalDesc = document.getElementById('strategyModalDesc');
  const strategyCloseBtn = strategyModal.querySelector('.modal-close');

  const breathingModal = document.getElementById('breathingModal');
  const breathingCloseBtn = breathingModal.querySelector('.modal-close');

  const journalEntry = document.getElementById('journalEntry');
  const saveJournalBtn = document.getElementById('saveJournalBtn');
  const journalMessage = document.getElementById('journalMessage');

  const moodButtons = [...document.querySelectorAll('.mood-btn')];
  const progressFill = document.querySelector('.progress-fill');
  const moodMessage = document.getElementById('moodMessage');

  const showAnalyticsBtn = document.getElementById('showAnalytics');
  const analyticsPanel = document.getElementById('analyticsPanel');
  const closeAnalyticsBtn = document.getElementById('closeAnalytics');
  const mostViewedSectionSpan = document.getElementById('mostViewedSection');
  const strategyClicksList = document.getElementById('strategyClicksList');

  // State
  let lastFocusedElement = null;
  let releaseFocusTrapGrief = null;
  let releaseFocusTrapStrategy = null;
  let releaseFocusTrapBreathing = null;

  // Tracking views and clicks
  const sectionViewCount = {
    'Understanding Grief': 0,
    'Coping Strategies': 0,
    'Journaling': 0,
    'Mood Tracker': 0,
    'Emergency Support': 0,
    'Additional Resources': 0,
    'Support Contacts': 0,
  };
  const strategyClicks = {
    'Breathing': 0,
    'Journaling': 0,
    'Exercise': 0,
    'Connection': 0,
    'Mindfulness': 0,
    'Help': 0,
  };

  // Strategy details
  const strategyDetails = {
    'Breathing': `Try this simple breathing exercise:
- Breathe in slowly through your nose for 4 seconds.
- Hold your breath for 4 seconds.
- Exhale gently through your mouth for 4 seconds.
- Repeat for several cycles until you feel calmer.`,

    'Journaling': `Write your feelings and thoughts down in a journal daily or whenever you feel overwhelmed. This helps process emotions and track your healing journey.`,

    'Exercise': `Engage in light physical activity such as walking, yoga, or stretching. Movement can boost mood and reduce stress.`,

    'Connection': `Reach out to friends, family, or support groups. Sharing your feelings can bring relief and help you feel less alone.`,

    'Mindfulness': `Practice being present in the moment through meditation, deep breathing, or mindful observation. This can reduce anxiety.`,

    'Help': `If feelings become overwhelming or persistent, consider seeking help from a mental health professional or crisis services.`
  };

  // Open Grief Modal
  griefBtn.addEventListener('click', () => {
    lastFocusedElement = document.activeElement;
    sectionViewCount['Understanding Grief']++;
    releaseFocusTrapGrief = openModal(griefModal);
    griefBtn.setAttribute('aria-expanded', 'true');
  });
  griefCloseBtn.addEventListener('click', () => {
    closeModal(griefModal, releaseFocusTrapGrief, lastFocusedElement);
    griefBtn.setAttribute('aria-expanded', 'false');
  });
  griefModal.addEventListener('click', e => {
    if (e.target === griefModal) {
      closeModal(griefModal, releaseFocusTrapGrief, lastFocusedElement);
      griefBtn.setAttribute('aria-expanded', 'false');
    }
  });

  // Coping strategy modal
  function openStrategyModal(name, content) {
    lastFocusedElement = document.activeElement;
    sectionViewCount['Coping Strategies']++;
    strategyClicks[name] = (strategyClicks[name] || 0) + 1;
    strategyModalTitle.textContent = name;
    strategyModalDesc.textContent = content;
    releaseFocusTrapStrategy = openModal(strategyModal);
  }
  strategyCloseBtn.addEventListener('click', () => {
    closeModal(strategyModal, releaseFocusTrapStrategy, lastFocusedElement);
  });
  strategyModal.addEventListener('click', e => {
    if (e.target === strategyModal) {
      closeModal(strategyModal, releaseFocusTrapStrategy, lastFocusedElement);
    }
  });

  // Breathing strategy opens special modal with animation and instructions
  document.querySelectorAll('.strategy-card').forEach(btn => {
    btn.addEventListener('click', () => {
      const strategy = btn.dataset.strategy;
      if (strategy === 'Breathing') {
        lastFocusedElement = document.activeElement;
        sectionViewCount['Coping Strategies']++;
        strategyClicks['Breathing']++;
        releaseFocusTrapBreathing = openModal(breathingModal);
        return;
      }
      // Others open normal modal
      openStrategyModal(strategy, strategyDetails[strategy]);
    });
  });
  breathingCloseBtn.addEventListener('click', () => {
    closeModal(breathingModal, releaseFocusTrapBreathing, lastFocusedElement);
  });
  breathingModal.addEventListener('click', e => {
    if (e.target === breathingModal) {
      closeModal(breathingModal, releaseFocusTrapBreathing, lastFocusedElement);
    }
  });

  // Journaling autosave/load
  function loadJournal() {
    const saved = localStorage.getItem('griefJournalEntry');
    if (saved) journalEntry.value = saved;
  }
  loadJournal();
  saveJournalBtn.addEventListener('click', () => {
    localStorage.setItem('griefJournalEntry', journalEntry.value);
    journalMessage.textContent = 'Entry saved successfully!';
    setTimeout(() => journalMessage.textContent = '', 3000);
  });

  // Mood Tracker
  let selectedMood = 0;
  const moodMessages = {
    1: "It's okay to feel very sad sometimes. Be gentle with yourself.",
    2: "Feeling sad is natural. Reach out if you need support.",
    3: "A neutral mood is a calm place; breathe and be present.",
    4: "Feeling happy is a gift—cherish those moments.",
    5: "Very happy! Celebrate your joys and keep smiling."
  };
  function updateMood(mood) {
    selectedMood = mood;
    moodButtons.forEach((btn, i) => {
      btn.setAttribute('aria-checked', i+1 === mood ? 'true' : 'false');
      btn.tabIndex = i+1 === mood ? 0 : -1;
    });
    const percent = (mood / 5) * 100;
    progressFill.style.width = percent + '%';
    moodMessage.textContent = moodMessages[mood] || '';
  }
  moodButtons.forEach((btn, i) => {
    btn.addEventListener('click', () => {
      updateMood(i+1);
      sectionViewCount['Mood Tracker']++;
    });
    btn.addEventListener('keydown', e => {
      if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
        e.preventDefault();
        const next = (i + 1) % moodButtons.length;
        moodButtons[next].focus();
      }
      else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
        e.preventDefault();
        const prev = (i - 1 + moodButtons.length) % moodButtons.length;
        moodButtons[prev].focus();
      }
      else if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        updateMood(i+1);
        sectionViewCount['Mood Tracker']++;
      }
    });
  });
  updateMood(3); // default neutral mood

  // Analytics panel
  function renderAnalytics() {
    // Most viewed section:
    let maxViews = 0, maxSection = 'None yet';
    for (const s in sectionViewCount) {
      if (sectionViewCount[s] > maxViews) {
        maxViews = sectionViewCount[s];
        maxSection = s;
      }
    }
    mostViewedSectionSpan.textContent = maxSection + (maxViews ? ` (${maxViews} view${maxViews>1?'s':''})` : '');

    // Strategy clicks list
    strategyClicksList.innerHTML = '';
    for (const strat in strategyClicks) {
      const count = strategyClicks[strat];
      const li = document.createElement('li');
      li.textContent = `${strat}: ${count} click${count !== 1 ? 's' : ''}`;
      strategyClicksList.appendChild(li);
    }
  }
  showAnalyticsBtn.addEventListener('click', () => {
    renderAnalytics();
    analyticsPanel.style.display = 'flex';
    showAnalyticsBtn.style.display = 'none';
    analyticsPanel.focus();
  });
  closeAnalyticsBtn.addEventListener('click', () => {
    analyticsPanel.style.display = 'none';
    showAnalyticsBtn.style.display = 'inline-block';
    showAnalyticsBtn.focus();
  });

})();
</script>

</body>
</html>