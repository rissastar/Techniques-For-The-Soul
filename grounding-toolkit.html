<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Enhanced Grounding Toolkit</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
<style>
  /* Reset & base styles */
  * {
    margin: 0; padding: 0; box-sizing: border-box;
  }
  body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
    color: white;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  body::before {
    content: '';
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background:
      radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
      radial-gradient(circle at 40% 40%, rgba(120, 219, 226, 0.2) 0%, transparent 50%);
    pointer-events: none; z-index: -1;
    transition: background-color 0.3s ease;
  }
  .container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 2rem;
    position: relative;
    z-index: 1;
  }
  .header {
    text-align: center;
    margin-bottom: 3rem;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    border-radius: 24px;
    padding: 2rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  }
  h1 {
    font-size: 3rem;
    font-weight: 700;
    background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  .subtitle {
    color: rgba(255, 255, 255, 0.8);
    font-size: 1.1rem;
    font-weight: 300;
    margin-bottom: 1rem;
  }
  .stats {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin-top: 1.5rem;
  }
  .stat {
    text-align: center;
    color: rgba(255, 255, 255, 0.9);
  }
  .stat-number {
    font-size: 1.5rem;
    font-weight: 600;
    display: block;
  }
  .stat-label {
    font-size: 0.9rem;
    opacity: 0.8;
  }
  .search-container {
    margin-bottom: 2rem;
    position: relative;
  }
  .search-input {
    width: 100%;
    padding: 1rem 1.5rem;
    font-size: 1rem;
    border: none;
    border-radius: 16px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(20px);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
  }
  .search-input::placeholder {
    color: rgba(255, 255, 255, 0.6);
  }
  .search-input:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.4);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }
  .category-filters {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    justify-content: center;
  }
  .filter-btn {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.9);
    padding: 0.7rem 1.2rem;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    user-select: none;
  }
  .filter-btn:hover, .filter-btn.active {
    background: rgba(255, 255, 255, 0.25);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }
  #accordion {
    display: grid;
    gap: 1rem;
  }
  .floating-action {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
    z-index: 1001;
  }
  .floating-action:hover {
    transform: scale(1.1) translateY(-2px);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4);
  }
  /* Modal styles */
  .modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1100;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .modal-overlay.active {
    opacity: 1;
    pointer-events: auto;
  }
  .modal {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(25px);
    border-radius: 20px;
    max-width: 600px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    padding: 1.5rem 2rem 2rem;
    color: white;
    position: relative;
  }
  .modal h2 {
    margin-bottom: 0.5rem;
    font-size: 2rem;
    font-weight: 700;
  }
  .modal .modal-emoji {
    font-size: 2.5rem;
    margin-left: 0.5rem;
  }
  .modal .modal-category {
    text-transform: uppercase;
    font-weight: 600;
    color: rgba(255,255,255,0.7);
    font-size: 0.85rem;
    margin-bottom: 1rem;
  }
  .modal .modal-content p,
  .modal .modal-content ul {
    margin-bottom: 1rem;
    font-weight: 400;
    line-height: 1.5;
  }
  .modal .modal-content ul {
    padding-left: 1.5rem;
  }
  .modal .modal-content li {
    margin-bottom: 0.5rem;
  }
  .modal-close {
    position: absolute;
    top: 1rem; right: 1rem;
    font-size: 2rem;
    color: white;
    cursor: pointer;
    user-select: none;
  }
  /* Card style replaced with clickable cards disabled, replaced with popups */
  .card-button {
    width: 100%;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 18px;
    padding: 1rem 1.5rem;
    color: white;
    font-weight: 600;
    font-size: 1.1rem;
    cursor: pointer;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: background 0.3s ease, box-shadow 0.3s ease;
    user-select: none;
  }
  .card-button:hover {
    background: rgba(255,255,255,0.3);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
  }
  .card-emoji {
    font-size: 1.7rem;
    flex-shrink: 0;
    filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
  }
  /* Checklist */
  .checklist {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.75rem;
    margin: 1rem 0;
  }
  .checklist-item {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    padding: 0.75rem 1rem;
    border-radius: 15px;
    text-align: center;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 500;
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
    cursor: pointer;
    user-select: none;
  }
  .checklist-item.checked {
    background: rgba(78, 205, 196, 0.4);
    border-color: #4ecdc4;
    color: #e0f7f7;
  }
  /* Notes journal */
  .notes-container {
    margin: 2rem 0;
  }
  .notes-container textarea {
    width: 100%;
    min-height: 120px;
    border-radius: 15px;
    border: none;
    padding: 1rem;
    font-size: 1rem;
    resize: vertical;
    font-family: 'Inter', sans-serif;
    background: rgba(255,255,255,0.15);
    color: white;
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255,255,255,0.2);
    transition: border-color 0.3s ease;
  }
  .notes-container textarea:focus {
    outline: none;
    border-color: #4ecdc4;
    background: rgba(78, 205, 196, 0.3);
  }
  /* Buttons */
  .button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    user-select: none;
    margin: 0.5rem 0;
  }
  .button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
  }
  /* Breathing animation */
  .breath-circle {
    width: 150px;
    height: 150px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    margin: 1rem auto;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 1.3rem;
    transition: transform 4s ease-in-out, border-color 4s ease-in-out, background-color 4s ease-in-out;
    user-select: none;
  }
  .breath-circle.inhale {
    transform: scale(1.3);
    border-color: #4ecdc4;
    background: rgba(78, 205, 196, 0.1);
  }
  .breath-circle.exhale {
    transform: scale(0.8);
    border-color: #ff6b6b;
    background: rgba(255, 107, 107, 0.1);
  }
  /* Toggle switches */
  .toggles {
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    margin: 2rem 0 1rem;
    flex-wrap: wrap;
  }
  .toggle-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 500;
    user-select: none;
    cursor: pointer;
  }
  .toggle-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
  }
  /* Responsive */
  @media (max-width: 768px) {
    .container {
      padding: 1rem;
    }
    h1 {
      font-size: 2rem;
    }
    .stats {
      gap: 1rem;
    }
    .category-filters {
      justify-content: flex-start;
      overflow-x: auto;
      padding-bottom: 0.5rem;
    }
    .checklist {
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    }
    .floating-action {
      bottom: 1rem;
      right: 1rem;
    }
  }
  /* Dark mode */
  body.dark {
    background: linear-gradient(135deg, #1e1e2f 0%, #29294a 100%);
    color: #ddd;
  }
  body.dark::before {
    background:
      radial-gradient(circle at 20% 80%, rgba(60, 60, 120, 0.3) 0%, transparent 50%),
      radial-gradient(circle at 80% 20%, rgba(120, 60, 90, 0.3) 0%, transparent 50%),
      radial-gradient(circle at 40% 40%, rgba(60, 120, 120, 0.2) 0%, transparent 50%);
  }
  body.dark .header {
    background: rgba(30, 30, 50, 0.5);
    border-color: rgba(100, 100, 150, 0.5);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }
  body.dark .filter-btn {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
    color: #ccc;
  }
  body.dark .filter-btn.active, body.dark .filter-btn:hover {
    background: rgba(255, 255, 255, 0.12);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
  }
  body.dark .card-button {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
  }
  body.dark .card-button:hover {
    background: rgba(255, 255, 255, 0.15);
    box-shadow: 0 8px 25px rgba(0,0,0,0.5);
  }
  body.dark .checklist-item {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.1);
    color: #ccc;
  }
  body.dark .checklist-item.checked {
    background: rgba(78, 205, 196, 0.6);
    border-color: #4ecdc4;
    color: #e0f7f7;
  }
  body.dark .notes-container textarea {
    background: rgba(255,255,255,0.07);
    color: #ddd;
    border-color: rgba(100, 100, 150, 0.4);
  }
</style>
</head>
<body>
<div class="container">
  <header class="header" role="banner">
    <h1>🌿 Grounding Toolkit</h1>
    <p class="subtitle">Your personal collection of mindfulness and grounding techniques</p>
    <div class="stats" aria-label="Toolkit statistics">
      <div class="stat" aria-live="polite">
        <span class="stat-number" id="tech-count">0</span>
        <span class="stat-label">Techniques</span>
      </div>
      <div class="stat" aria-live="polite">
        <span class="stat-number" id="favorites-count">0</span>
        <span class="stat-label">Favorites</span>
      </div>
      <div class="stat" aria-live="polite">
        <span class="stat-number" id="daily-streak">0</span>
        <span class="stat-label">Daily Streak</span>
      </div>
    </div>
  </header>

  <section aria-label="Search techniques">
    <input
      type="search"
      id="search-input"
      class="search-input"
      placeholder="Search techniques..."
      aria-label="Search techniques"
      autocomplete="off"
    />
  </section>

  <nav class="category-filters" aria-label="Filter techniques by category">
    <button class="filter-btn active" data-category="all" aria-pressed="true">All</button>
    <button class="filter-btn" data-category="physical" aria-pressed="false">Physical</button>
    <button class="filter-btn" data-category="breathing" aria-pressed="false">Breathing</button>
    <button class="filter-btn" data-category="visualization" aria-pressed="false">Visualization</button>
    <button class="filter-btn" data-category="mindfulness" aria-pressed="false">Mindfulness</button>
    <button class="filter-btn" data-category="emotional" aria-pressed="false">Emotional</button>
    <button class="filter-btn" data-category="creative" aria-pressed="false">Creative</button>
    <button class="filter-btn" data-category="emergency" aria-pressed="false">Emergency</button>
  </nav>

  <main id="accordion" aria-live="polite" aria-relevant="additions removals" role="region" tabindex="0" aria-label="Grounding techniques list">
    <!-- Technique buttons inserted here dynamically -->
  </main>

  <div class="checklist" aria-label="Daily grounding checklist" role="list">
    <!-- checklist items inserted dynamically -->
  </div>

  <section class="notes-container" aria-label="Personal notes and journal">
    <h2>Journal / Notes</h2>
    <textarea id="notes-textarea" placeholder="Write your grounding thoughts here..."></textarea>
  </section>

  <section class="breathing-exercise" aria-label="Guided breathing exercise">
    <h2>Guided Breathing</h2>
    <div class="breath-circle" aria-live="polite" aria-atomic="true" aria-label="Breathing animation circle" role="img">
      <span id="breath-text">Breathe In</span>
    </div>
    <button class="button" id="start-breathing">Start Breathing Exercise</button>
    <button class="button" id="stop-breathing" disabled>Stop Breathing Exercise</button>
  </section>

  <section class="toggles" aria-label="Settings toggles">
    <label class="toggle-label" for="toggle-darkmode">
      <input type="checkbox" id="toggle-darkmode" /> Dark Mode
    </label>
    <label class="toggle-label" for="toggle-music">
      <input type="checkbox" id="toggle-music" /> Background Music
    </label>
  </section>

  <button class="button" id="download-pdf" aria-label="Download grounding techniques guide PDF">Download PDF Guide</button>

  <button class="floating-action" id="add-technique" aria-label="Add new grounding technique">+</button>
</div>

<!-- Modal -->
<div class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title" tabindex="-1" id="modal-overlay" hidden>
  <div class="modal" role="document">
    <button class="modal-close" aria-label="Close modal" id="modal-close">&times;</button>
    <h2 id="modal-title"></h2>
    <span class="modal-emoji" id="modal-emoji"></span>
    <div class="modal-category" id="modal-category"></div>
    <div class="modal-content" id="modal-content"></div>
  </div>
</div>

<!-- Audio for background music -->
<audio id="bg-music" loop>
  <source src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_63a139e99b.mp3?filename=relaxing-meditation-ambient-11206.mp3" type="audio/mpeg" />
  Your browser does not support the audio element.
</audio>

<!-- Audio for breathing cues -->
<audio id="breath-in-sound" src="https://actions.google.com/sounds/v1/human_voices/breath_in.ogg"></audio>
<audio id="breath-out-sound" src="https://actions.google.com/sounds/v1/human_voices/breath_out.ogg"></audio>

<script>
(() => {
  'use strict';

  // ======== Data ========
  const techniques = [
    {
      id: 'tech1',
      title: '5-4-3-2-1 Grounding',
      category: 'mindfulness',
      emoji: '🧠',
      content: `<p>This classic grounding exercise helps you focus on your senses:</p>
      <ul>
        <li><strong>5</strong> things you can see</li>
        <li><strong>4</strong> things you can touch</li>
        <li><strong>3</strong> things you can hear</li>
        <li><strong>2</strong> things you can smell</li>
        <li><strong>1</strong> thing you can taste</li>
      </ul>`
    },
    {
      id: 'tech2',
      title: 'Box Breathing',
      category: 'breathing',
      emoji: '📦',
      content: `<p>Box breathing is a simple technique that involves breathing in 4 counts, holding for 4, breathing out for 4, and holding for 4:</p>
      <ul>
        <li>Breathe in for 4 seconds</li>
        <li>Hold your breath for 4 seconds</li>
        <li>Breathe out for 4 seconds</li>
        <li>Hold your breath for 4 seconds</li>
      </ul>`
    },
    {
      id: 'tech3',
      title: 'Physical Grounding',
      category: 'physical',
      emoji: '🦶',
      content: `<p>Feel your feet on the ground. Press firmly on the floor and notice the sensation. Wiggle your toes.</p>`
    },
    {
      id: 'tech4',
      title: 'Visualization: Safe Place',
      category: 'visualization',
      emoji: '🏞️',
      content: `<p>Imagine a safe, calm place where you feel completely at peace. Visualize all the details, colors, sounds, and smells.</p>`
    },
    {
      id: 'tech5',
      title: 'Emotion Naming',
      category: 'emotional',
      emoji: '📝',
      content: `<p>Identify and name your emotions clearly. Saying them out loud or writing them down can reduce their intensity.</p>`
    },
    {
      id: 'tech6',
      title: 'Creative Expression',
      category: 'creative',
      emoji: '🎨',
      content: `<p>Use drawing, writing, or music to express how you feel.</p>`
    },
    {
      id: 'tech7',
      title: 'Emergency: Call a Support Person',
      category: 'emergency',
      emoji: '📞',
      content: `<p>If you are overwhelmed, call a trusted friend, family member, or crisis line immediately.</p>
      <p><a href="tel:911" style="color:#4ecdc4;">Call 911 (Emergency Services)</a></p>`
    }
  ];

  // ======== DOM Elements ========
  const accordion = document.getElementById('accordion');
  const searchInput = document.getElementById('search-input');
  const filterButtons = document.querySelectorAll('.filter-btn');
  const modalOverlay = document.getElementById('modal-overlay');
  const modalClose = document.getElementById('modal-close');
  const modalTitle = document.getElementById('modal-title');
  const modalEmoji = document.getElementById('modal-emoji');
  const modalCategory = document.getElementById('modal-category');
  const modalContent = document.getElementById('modal-content');
  const techCountEl = document.getElementById('tech-count');
  const favoritesCountEl = document.getElementById('favorites-count');
  const dailyStreakEl = document.getElementById('daily-streak');
  const checklistContainer = document.querySelector('.checklist');
  const notesTextarea = document.getElementById('notes-textarea');
  const startBreathingBtn = document.getElementById('start-breathing');
  const stopBreathingBtn = document.getElementById('stop-breathing');
  const breathCircle = document.querySelector('.breath-circle');
  const breathText = document.getElementById('breath-text');
  const toggleDarkmode = document.getElementById('toggle-darkmode');
  const toggleMusic = document.getElementById('toggle-music');
  const bgMusic = document.getElementById('bg-music');
  const addTechniqueBtn = document.getElementById('add-technique');
  const downloadPdfBtn = document.getElementById('download-pdf');

  // ======== State ========
  let filteredCategory = 'all';
  let favorites = new Set(JSON.parse(localStorage.getItem('favorites')) || []);
  let checklist = JSON.parse(localStorage.getItem('checklist')) || {};
  let notes = localStorage.getItem('notes') || '';
  let dailyStreak = parseInt(localStorage.getItem('dailyStreak')) || 0;
  let lastVisitDate = localStorage.getItem('lastVisitDate');
  let breathingInterval = null;
  let breathingPhase = 0; // 0: inhale, 1: hold, 2: exhale, 3: hold
  let breathingStepDuration = 4000; // milliseconds
  let breathingRunning = false;

  // ======== Functions ========

  // Save favorites & checklist & notes & streak
  function saveState() {
    localStorage.setItem('favorites', JSON.stringify(Array.from(favorites)));
    localStorage.setItem('checklist', JSON.stringify(checklist));
    localStorage.setItem('notes', notesTextarea.value);
    localStorage.setItem('dailyStreak', dailyStreak.toString());
  }

  // Update stats display
  function updateStats() {
    techCountEl.textContent = techniques.length.toString();
    favoritesCountEl.textContent = favorites.size.toString();
    dailyStreakEl.textContent = dailyStreak.toString();
  }

  // Render techniques filtered by search and category
  function renderTechniques() {
    const searchTerm = searchInput.value.toLowerCase();
    accordion.innerHTML = '';
    let count = 0;

    techniques.forEach(tech => {
      const matchCategory = filteredCategory === 'all' || tech.category === filteredCategory;
      const matchSearch = tech.title.toLowerCase().includes(searchTerm) || tech.content.toLowerCase().includes(searchTerm);
      if (matchCategory && matchSearch) {
        count++;
        const btn = document.createElement('button');
        btn.className = 'card-button';
        btn.setAttribute('aria-expanded', 'false');
        btn.setAttribute('aria-controls', `content-${tech.id}`);
        btn.type = 'button';
        btn.dataset.id = tech.id;
        btn.innerHTML = `<span class="card-emoji" aria-hidden="true">${tech.emoji}</span> ${tech.title}`;
        btn.addEventListener('click', () => openModal(tech.id));
        accordion.appendChild(btn);
      }
    });

    if (count === 0) {
      accordion.innerHTML = `<p>No techniques found.</p>`;
    }
  }

  // Render checklist items
  function renderChecklist() {
    checklistContainer.innerHTML = '';
    techniques.forEach(tech => {
      const item = document.createElement('div');
      item.className = 'checklist-item';
      if (checklist[tech.id]) item.classList.add('checked');
      item.setAttribute('role', 'listitem');
      item.setAttribute('tabindex', '0');
      item.textContent = tech.title;
      item.addEventListener('click', () => toggleChecklistItem(tech.id, item));
      item.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleChecklistItem(tech.id, item);
        }
      });
      checklistContainer.appendChild(item);
    });
  }

  function toggleChecklistItem(id, elem) {
    if (checklist[id]) {
      delete checklist[id];
      elem.classList.remove('checked');
    } else {
      checklist[id] = true;
      elem.classList.add('checked');
    }
    saveState();
  }

  // Open modal with technique details
  function openModal(id) {
    const tech = techniques.find(t => t.id === id);
    if (!tech) return;
    modalTitle.textContent = tech.title;
    modalEmoji.textContent = tech.emoji;
    modalCategory.textContent = tech.category.toUpperCase();
    modalContent.innerHTML = tech.content;
    modalOverlay.hidden = false;
    modalOverlay.classList.add('active');
    modalClose.focus();
  }

  // Close modal
  function closeModal() {
    modalOverlay.classList.remove('active');
    setTimeout(() => {
      modalOverlay.hidden = true;
      searchInput.focus();
    }, 300);
  }

  // Breathing animation cycle
  function startBreathing() {
    if (breathingRunning) return;
    breathingRunning = true;
    breathingPhase = 0;
    startBreathingBtn.disabled = true;
    stopBreathingBtn.disabled = false;
    breathCycle();
  }

  function stopBreathing() {
    breathingRunning = false;
    clearTimeout(breathingInterval);
    startBreathingBtn.disabled = false;
    stopBreathingBtn.disabled = true;
    breathCircle.classList.remove('inhale', 'exhale');
    breathText.textContent = 'Breathe In';
  }

  function breathCycle() {
    if (!breathingRunning) return;

    switch (breathingPhase) {
      case 0:
        breathCircle.classList.add('inhale');
        breathCircle.classList.remove('exhale');
        breathText.textContent = 'Breathe In';
        document.getElementById('breath-in-sound').play().catch(() => {});
        breathingPhase++;
        breathingInterval = setTimeout(breathCycle, breathingStepDuration);
        break;
      case 1:
        breathText.textContent = 'Hold';
        breathingPhase++;
        breathingInterval = setTimeout(breathCycle, breathingStepDuration);
        break;
      case 2:
        breathCircle.classList.remove('inhale');
        breathCircle.classList.add('exhale');
        breathText.textContent = 'Breathe Out';
        document.getElementById('breath-out-sound').play().catch(() => {});
        breathingPhase++;
        breathingInterval = setTimeout(breathCycle, breathingStepDuration);
        break;
      case 3:
        breathText.textContent = 'Hold';
        breathingPhase = 0;
        breathingInterval = setTimeout(breathCycle, breathingStepDuration);
        break;
    }
  }

  // Filter button click handler
  filterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      filterButtons.forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-pressed', 'false');
      });
      btn.classList.add('active');
      btn.setAttribute('aria-pressed', 'true');
      filteredCategory = btn.dataset.category;
      renderTechniques();
    });
  });

  // Search input handler
  searchInput.addEventListener('input', () => {
    renderTechniques();
  });

  // Modal close handlers
  modalClose.addEventListener('click', closeModal);
  modalOverlay.addEventListener('click', e => {
    if (e.target === modalOverlay) closeModal();
  });
  window.addEventListener('keydown', e => {
    if (e.key === 'Escape' && !modalOverlay.hidden) closeModal();
  });

  // Notes textarea autosave
  notesTextarea.value = notes;
  notesTextarea.addEventListener('input', e => {
    notes = e.target.value;
    saveState();
  });

  // Dark mode toggle
  toggleDarkmode.checked = localStorage.getItem('darkmode') === 'true';
  if (toggleDarkmode.checked) document.body.classList.add('dark');
  toggleDarkmode.addEventListener('change', e => {
    if (e.target.checked) {
      document.body.classList.add('dark');
      localStorage.setItem('darkmode', 'true');
    } else {
      document.body.classList.remove('dark');
      localStorage.setItem('darkmode', 'false');
    }
  });

  // Background music toggle
  toggleMusic.checked = localStorage.getItem('bgMusic') === 'true';
  if (toggleMusic.checked) {
    bgMusic.volume = 0.15;
    bgMusic.play().catch(() => {});
  }
  toggleMusic.addEventListener('change', e => {
    if (e.target.checked) {
      bgMusic.volume = 0.15;
      bgMusic.play().catch(() => {});
      localStorage.setItem('bgMusic', 'true');
    } else {
      bgMusic.pause();
      localStorage.setItem('bgMusic', 'false');
    }
  });

  // Daily streak update
  function updateDailyStreak() {
    const today = new Date().toISOString().slice(0, 10);
    if (lastVisitDate !== today) {
      // Check if yesterday was last visit
      const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
      if (lastVisitDate === yesterday) {
        dailyStreak++;
      } else {
        dailyStreak = 1;
      }
      localStorage.setItem('lastVisitDate', today);
      localStorage.setItem('dailyStreak', dailyStreak.toString());
      lastVisitDate = today;
    }
  }

  // Add new technique (prompt form)
  addTechniqueBtn.addEventListener('click', () => {
    const title = prompt('Enter technique title:').trim();
    if (!title) return alert('Title cannot be empty.');
    const category = prompt('Enter category (physical, breathing, visualization, mindfulness, emotional, creative, emergency):').trim().toLowerCase();
    if (!category || !['physical', 'breathing', 'visualization', 'mindfulness', 'emotional', 'creative', 'emergency'].includes(category)) {
      return alert('Invalid category.');
    }
    const emoji = prompt('Enter an emoji for the technique:').trim() || '✨';
    const content = prompt('Enter technique description (HTML allowed):').trim();
    if (!content) return alert('Description cannot be empty.');

    const newTech = {
      id: 'tech' + (techniques.length + 1),
      title,
      category,
      emoji,
      content,
    };
    techniques.push(newTech);
    renderTechniques();
    renderChecklist();
    updateStats();
    alert('New technique added!');
  });

  // PDF download (simple text/pdf generation)
  downloadPdfBtn.addEventListener('click', () => {
    let docContent = 'Grounding Techniques Guide\n\n';
    techniques.forEach(tech => {
      docContent += `${tech.emoji} ${tech.title.toUpperCase()}\nCategory: ${tech.category}\n\n${stripHtml(tech.content)}\n\n---\n\n`;
    });

    const blob = new Blob([docContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Grounding_Techniques_Guide.txt';
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }, 0);
  });

  // Utility: strip HTML tags for PDF content
  function stripHtml(html) {
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || '';
  }

  // Initial rendering & setup
  updateDailyStreak();
  updateStats();
  renderTechniques();
  renderChecklist();

  // Breathing buttons
  startBreathingBtn.addEventListener('click', startBreathing);
  stopBreathingBtn.addEventListener('click', stopBreathing);

  // Accessibility: trap focus in modal
  modalOverlay.addEventListener('keydown', e => {
    if (e.key === 'Tab') {
      const focusable = modalOverlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      if (focusable.length === 0) return;
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      if (e.shiftKey) {
        if (document.activeElement === first) {
          e.preventDefault();
          last.focus();
        }
      } else {
        if (document.activeElement === last) {
          e.preventDefault();
          first.focus();
        }
      }
    }
  });
})();
</script>
</body>
</html>