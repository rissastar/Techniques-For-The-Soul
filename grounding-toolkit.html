<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Enhanced Grounding Toolkit</title>
<style>
  /* Reset & base */
  *, *::before, *::after {
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 0;
    background: linear-gradient(135deg, #a3cef1 0%, #f7f7f7 100%);
    color: #222;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    transition: background-color 0.5s, color 0.5s;
  }
  body.dark {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    color: #e0e6f0;
  }

  /* Container */
  .container {
    max-width: 900px;
    margin: 1rem auto 2rem;
    padding: 1rem 1.5rem 3rem;
    background: rgba(255 255 255 / 0.85);
    border-radius: 1rem;
    box-shadow:
      0 4px 6px rgba(0,0,0,0.1),
      inset 0 0 60px rgba(255 255 255 / 0.4);
    backdrop-filter: saturate(180%) blur(10px);
    transition: background 0.5s, color 0.5s;
  }
  body.dark .container {
    background: rgba(30 41 59 / 0.85);
    box-shadow:
      0 4px 12px rgba(0,0,0,0.7),
      inset 0 0 80px rgba(0 0 0 / 0.6);
  }

  h1 {
    text-align: center;
    font-weight: 700;
    font-size: 2.2rem;
    margin-bottom: 0.25rem;
  }
  header p {
    text-align: center;
    font-weight: 500;
    color: #4a4a4a;
    margin-top: 0;
  }
  body.dark header p {
    color: #a0aec0;
  }

  /* Stats */
  .stats {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    margin: 1rem 0 1.5rem;
  }
  .stat {
    text-align: center;
    user-select: none;
  }
  .stat-number {
    font-size: 1.5rem;
    font-weight: 600;
    display: block;
  }
  .stat-label {
    font-size: 0.85rem;
    color: #777;
  }
  body.dark .stat-label {
    color: #a0aec0;
  }

  /* Search */
  #search-input {
    width: 100%;
    font-size: 1rem;
    padding: 0.6rem 1rem;
    border-radius: 0.75rem;
    border: 2px solid #4ecdc4;
    outline-offset: 2px;
    transition: border-color 0.3s;
  }
  #search-input:focus {
    border-color: #3aafa9;
  }
  body.dark #search-input {
    background: #1e293b;
    border-color: #81e6d9;
    color: #e0e6f0;
  }
  body.dark #search-input:focus {
    border-color: #38b2ac;
  }

  /* Category filters */
  .category-filters {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.75rem;
    margin: 1rem 0 2rem;
  }
  .filter-btn {
    background: #4ecdc4;
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  .filter-btn[aria-pressed="true"],
  .filter-btn:hover {
    background: #3aafa9;
  }
  body.dark .filter-btn {
    background: #81e6d9;
    color: #0f172a;
  }
  body.dark .filter-btn[aria-pressed="true"],
  body.dark .filter-btn:hover {
    background: #38b2ac;
    color: #e0e6f0;
  }

  /* Technique buttons */
  #accordion {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(260px,1fr));
    gap: 1rem;
  }
  .card-button {
    background: #fff;
    border-radius: 1rem;
    box-shadow:
      0 8px 15px rgba(0,0,0,0.1),
      inset 0 0 12px rgba(255 255 255 / 0.6);
    padding: 1rem 1.25rem;
    border: 2px solid transparent;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 0.7rem;
    transition:
      box-shadow 0.3s,
      border-color 0.3s,
      background-color 0.3s;
    user-select: none;
  }
  .card-button:hover,
  .card-button:focus-visible {
    border-color: #4ecdc4;
    box-shadow:
      0 12px 20px rgba(0,0,0,0.15),
      inset 0 0 15px rgba(78 205 196 / 0.8);
    outline: none;
  }
  body.dark .card-button {
    background: #1e293b;
    color: #e0e6f0;
    box-shadow:
      0 8px 15px rgba(0,0,0,0.4),
      inset 0 0 12px rgba(129 230 217 / 0.6);
  }
  body.dark .card-button:hover,
  body.dark .card-button:focus-visible {
    border-color: #38b2ac;
    box-shadow:
      0 12px 20px rgba(0,0,0,0.7),
      inset 0 0 18px rgba(56 178 172 / 0.9);
    outline: none;
  }
  .card-emoji {
    font-size: 1.7rem;
    user-select: none;
  }

  /* Checklist */
  .checklist {
    margin: 2rem 0;
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
    gap: 0.5rem;
  }
  .checklist-item {
    background: #f3f7f9;
    border-radius: 0.75rem;
    padding: 0.6rem 1rem;
    cursor: pointer;
    user-select: none;
    border: 2px solid transparent;
    transition: background-color 0.3s, border-color 0.3s;
  }
  .checklist-item.checked {
    background: #4ecdc4;
    color: white;
    border-color: #3aafa9;
  }
  .checklist-item:focus-visible {
    outline: 3px solid #4ecdc4;
  }
  body.dark .checklist-item {
    background: #2a3448;
    color: #e0e6f0;
  }
  body.dark .checklist-item.checked {
    background: #38b2ac;
    color: #f0fdfa;
  }

  /* Notes container */
  .notes-container {
    margin-top: 2rem;
  }
  .notes-container h2 {
    font-weight: 700;
    margin-bottom: 0.5rem;
  }
  #notes-textarea {
    width: 100%;
    min-height: 120px;
    border-radius: 1rem;
    border: 2px solid #4ecdc4;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    resize: vertical;
    transition: border-color 0.3s;
  }
  #notes-textarea:focus {
    border-color: #3aafa9;
    outline: none;
  }
  body.dark #notes-textarea {
    background: #1e293b;
    color: #e0e6f0;
    border-color: #81e6d9;
  }
  body.dark #notes-textarea:focus {
    border-color: #38b2ac;
  }

  /* Breathing exercise */
  .breathing-exercise {
    margin-top: 2.5rem;
    text-align: center;
  }
  .breathing-exercise h2 {
    font-weight: 700;
    margin-bottom: 1rem;
  }
  .breath-circle {
    margin: 0 auto 1rem;
    width: 130px;
    height: 130px;
    border-radius: 50%;
    background: #4ecdc4;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 1.4rem;
    user-select: none;
    transition: background-color 0.3s, transform 2.5s ease-in-out;
    box-shadow:
      0 0 25px #4ecdc4aa,
      inset 0 0 15px #4ecdc4cc;
  }
  .breath-circle.inhale {
    animation: pulseInhale 4s ease-in-out infinite;
    background: #3aafa9;
    box-shadow:
      0 0 40px #3aafa9cc,
      inset 0 0 20px #3aafa9dd;
  }
  .breath-circle.exhale {
    animation: pulseExhale 4s ease-in-out infinite;
    background: #71e6d1;
    box-shadow:
      0 0 40px #71e6d1cc,
      inset 0 0 20px #71e6d1dd;
  }
  @keyframes pulseInhale {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.15); }
  }
  @keyframes pulseExhale {
    0%, 100% { transform: scale(1.15); }
    50% { transform: scale(1); }
  }
  #breath-text {
    pointer-events: none;
  }
  .button {
    background: #4ecdc4;
    border: none;
    color: white;
    padding: 0.6rem 1.2rem;
    border-radius: 9999px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    margin: 0 0.5rem;
    transition: background-color 0.3s;
    user-select: none;
  }
  .button:disabled {
    background: #a5e1da;
    cursor: not-allowed;
  }
  .button:hover:not(:disabled),
  .button:focus-visible:not(:disabled) {
    background: #3aafa9;
    outline: none;
  }
  body.dark .button {
    background: #81e6d9;
    color: #0f172a;
  }
  body.dark .button:disabled {
    background: #5bd6c9;
  }
  body.dark .button:hover:not(:disabled),
  body.dark .button:focus-visible:not(:disabled) {
    background: #38b2ac;
    color: #f0fdfa;
  }

  /* Toggles */
  .toggles {
    margin-top: 2rem;
    display: flex;
    justify-content: center;
    gap: 2.5rem;
  }
  .toggle-label {
    user-select: none;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
  }
  .toggle-label input {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  /* Download PDF */
  #download-pdf {
    margin: 2rem auto 0;
    display: block;
  }

  /* Floating Add Button */
  .floating-action {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: #4ecdc4;
    border: none;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    font-size: 2rem;
    color: white;
    cursor: pointer;
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    user-select: none;
    transition: background-color 0.3s;
    z-index: 1100;
  }
  .floating-action:hover,
  .floating-action:focus-visible {
    background: #3aafa9;
    outline: none;
  }
  body.dark .floating-action {
    background: #81e6d9;
    color: #0f172a;
  }
  body.dark .floating-action:hover,
  body.dark .floating-action:focus-visible {
    background: #38b2ac;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s ease;
    z-index: 1200;
  }
  .modal-overlay.active {
    opacity: 1;
    pointer-events: auto;
  }
  .modal {
    background: white;
    border-radius: 1rem;
    max-width: 450px;
    width: 90vw;
    max-height: 85vh;
    overflow-y: auto;
    padding: 1.5rem 2rem 2rem;
    box-shadow:
      0 10px 20px rgba(0,0,0,0.25);
    position: relative;
    color: #222;
  }
  body.dark .modal {
    background: #1e293b;
    color: #e0e6f0;
    box-shadow:
      0 10px 20px rgba(0,0,0,0.7);
  }
  .modal-close {
    position: absolute;
    top: 0.8rem;
    right: 1rem;
    font-size: 2rem;
    background: none;
    border: none;
    cursor: pointer;
    color: #888;
    transition: color 0.3s;
  }
  .modal-close:hover,
  .modal-close:focus-visible {
    color: #4ecdc4;
    outline: none;
  }
  body.dark .modal-close {
    color: #a0aec0;
  }
  body.dark .modal-close:hover,
  body.dark .modal-close:focus-visible {
    color: #38b2ac;
  }

  #modal-title {
    margin: 0 0 0.25rem;
    font-weight: 700;
    font-size: 1.5rem;
  }
  #modal-emoji {
    font-size: 2rem;
    user-select: none;
  }
  #modal-category {
    font-weight: 600;
    font-size: 0.9rem;
    margin: 0.1rem 0 1rem;
    color: #4ecdc4;
  }
  body.dark #modal-category {
    color: #38b2ac;
  }
  #modal-content p,
  #modal-content ul {
    line-height: 1.4;
  }
  #modal-content ul {
    padding-left: 1.2rem;
  }
  #modal-content li {
    margin-bottom: 0.3rem;
  }

  /* Responsive tweaks */
  @media (max-width: 600px) {
    #accordion {
      grid-template-columns: 1fr;
    }
    .stats {
      flex-direction: column;
      gap: 0.75rem;
    }
    .toggles {
      flex-direction: column;
      gap: 1rem;
      align-items: center;
    }
  }
</style>
</head>
<body>
<div class="container" role="main" aria-label="Enhanced Grounding Toolkit">

  <header>
    <h1>Enhanced Grounding Toolkit</h1>
    <p>Your interactive guide to calming techniques</p>

    <div class="stats" aria-label="Toolkit statistics">
      <div class="stat" aria-live="polite">
        <span class="stat-number" id="tech-count">0</span>
        <span class="stat-label">Techniques</span>
      </div>
      <div class="stat" aria-live="polite">
        <span class="stat-number" id="favorites-count">0</span>
        <span class="stat-label">Favorites</span>
      </div>
      <div class="stat" aria-live="polite">
        <span class="stat-number" id="daily-streak">0</span>
        <span class="stat-label">Daily Streak</span>
      </div>
    </div>
  </header>

  <section aria-label="Search techniques">
    <input
      type="search"
      id="search-input"
      class="search-input"
      placeholder="Search techniques..."
      aria-label="Search techniques"
      autocomplete="off"
    />
  </section>

  <nav class="category-filters" aria-label="Filter techniques by category">
    <button class="filter-btn active" data-category="all" aria-pressed="true">All</button>
    <button class="filter-btn" data-category="physical" aria-pressed="false">Physical</button>
    <button class="filter-btn" data-category="breathing" aria-pressed="false">Breathing</button>
    <button class="filter-btn" data-category="visualization" aria-pressed="false">Visualization</button>
    <button class="filter-btn" data-category="mindfulness" aria-pressed="false">Mindfulness</button>
    <button class="filter-btn" data-category="emotional" aria-pressed="false">Emotional</button>
    <button class="filter-btn" data-category="creative" aria-pressed="false">Creative</button>
    <button class="filter-btn" data-category="emergency" aria-pressed="false">Emergency</button>
  </nav>

  <section id="accordion" aria-label="Grounding techniques list" tabindex="0">
    <!-- Technique buttons dynamically inserted here -->
  </section>

  <section aria-label="Grounding checklist">
    <h2>Daily Checklist</h2>
    <div class="checklist" id="checklist">
      <!-- Checklist items dynamically inserted here -->
    </div>
  </section>

  <section class="notes-container" aria-label="Personal notes">
    <h2>Notes Journal</h2>
    <textarea
      id="notes-textarea"
      aria-label="Your personal notes journal"
      placeholder="Write your notes here..."
      spellcheck="true"
      autocomplete="off"
    ></textarea>
  </section>

  <section class="breathing-exercise" aria-label="Guided breathing exercise">
    <h2>Guided Breathing</h2>
    <div id="breath-circle" class="breath-circle" aria-live="polite" aria-atomic="true" aria-relevant="text">Ready</div>
    <div>
      <button id="start-breathing-btn" class="button" aria-label="Start guided breathing exercise">Start</button>
      <button id="stop-breathing-btn" class="button" disabled aria-label="Stop guided breathing exercise">Stop</button>
    </div>
  </section>

  <section class="toggles" aria-label="Settings toggles">
    <label class="toggle-label" for="toggle-music">
      <input type="checkbox" id="toggle-music" />
      Background Music
    </label>
    <label class="toggle-label" for="toggle-darkmode">
      <input type="checkbox" id="toggle-darkmode" />
      Dark Mode
    </label>
  </section>

  <button id="download-pdf" class="button" aria-label="Download grounding techniques guide">Download Guide PDF</button>

  <button class="floating-action" id="add-tech-btn" title="Add your own technique" aria-label="Add your own technique">+</button>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-describedby="modal-content" tabindex="-1" hidden>
  <div class="modal" role="document">
    <button class="modal-close" id="modal-close" aria-label="Close modal">&times;</button>
    <h3 id="modal-emoji" aria-hidden="true"></h3>
    <h2 id="modal-title"></h2>
    <div id="modal-category"></div>
    <div id="modal-content"></div>
  </div>
</div>

<!-- Audio -->
<audio id="breath-sound-inhale" src="https://actions.google.com/sounds/v1/ambiences/breathing_in.ogg" preload="auto"></audio>
<audio id="breath-sound-exhale" src="https://actions.google.com/sounds/v1/ambiences/breathing_out.ogg" preload="auto"></audio>
<audio id="bg-music" loop src="https://cdn.pixabay.com/download/audio/2022/03/17/audio_01bf9a165f.mp3?filename=relaxing-ambient-11244.mp3" preload="auto"></audio>

<script>
(() => {
  // Data: techniques
  let techniques = [
    {
      id: 'tech1',
      title: '5-4-3-2-1 Grounding',
      category: 'mindfulness',
      emoji: 'üß†',
      content: `<p>Use your five senses to ground yourself:</p>
      <ul>
        <li>5 things you can see</li>
        <li>4 things you can touch</li>
        <li>3 things you can hear</li>
        <li>2 things you can smell</li>
        <li>1 thing you can taste</li>
      </ul>`
    },
    {
      id: 'tech2',
      title: 'Box Breathing',
      category: 'breathing',
      emoji: 'üì¶',
      content: `<p>Inhale 4 seconds ‚Üí Hold 4 seconds ‚Üí Exhale 4 seconds ‚Üí Hold 4 seconds ‚Üí Repeat.</p>`
    },
    {
      id: 'tech3',
      title: 'Physical Grounding',
      category: 'physical',
      emoji: '‚úã',
      content: `<p>Press your feet firmly into the ground and notice the feeling.</p>`
    },
    {
      id: 'tech4',
      title: 'Visualization: Safe Place',
      category: 'visualization',
      emoji: 'üèùÔ∏è',
      content: `<p>Visualize a peaceful, safe place where you feel calm.</p>`
    },
    {
      id: 'tech5',
      title: 'Mindful Observation',
      category: 'mindfulness',
      emoji: 'üëÄ',
      content: `<p>Focus intently on an object nearby, noticing all details.</p>`
    },
    {
      id: 'tech6',
      title: 'Name Your Emotion',
      category: 'emotional',
      emoji: 'üìù',
      content: `<p>Label your current feeling to help process it.</p>`
    },
    {
      id: 'tech7',
      title: 'Creative Expression',
      category: 'creative',
      emoji: 'üé®',
      content: `<p>Draw, write, or craft something to express yourself.</p>`
    },
    {
      id: 'tech8',
      title: 'Emergency Contact Plan',
      category: 'emergency',
      emoji: 'üö®',
      content: `<p>Have a list of people or services you can contact in crisis.</p>`
    }
  ];

  // Cached DOM
  const accordion = document.getElementById('accordion');
  const searchInput = document.getElementById('search-input');
  const checklist = document.getElementById('checklist');
  const notesTextarea = document.getElementById('notes-textarea');
  const breathCircle = document.getElementById('breath-circle');
  const startBreathingBtn = document.getElementById('start-breathing-btn');
  const stopBreathingBtn = document.getElementById('stop-breathing-btn');
  const toggleMusic = document.getElementById('toggle-music');
  const toggleDarkMode = document.getElementById('toggle-darkmode');
  const downloadPdfBtn = document.getElementById('download-pdf');
  const addTechBtn = document.getElementById('add-tech-btn');
  const modalOverlay = document.getElementById('modal-overlay');
  const modalCloseBtn = document.getElementById('modal-close');
  const modalTitle = document.getElementById('modal-title');
  const modalEmoji = document.getElementById('modal-emoji');
  const modalCategory = document.getElementById('modal-category');
  const modalContent = document.getElementById('modal-content');

  const breathSoundInhale = document.getElementById('breath-sound-inhale');
  const breathSoundExhale = document.getElementById('breath-sound-exhale');
  const bgMusic = document.getElementById('bg-music');

  // State
  let currentCategory = 'all';
  let filteredTechniques = [];
  let checklistState = JSON.parse(localStorage.getItem('groundingChecklist')) || {};
  let notes = localStorage.getItem('groundingNotes') || '';
  let favorites = JSON.parse(localStorage.getItem('groundingFavorites')) || {};
  let breathingInterval = null;
  let breathingPhase = 0; // 0: inhale,1: hold1,2: exhale,3: hold2
  let breathingRunning = false;
  let dailyStreak = 0;
  let lastVisitDate = localStorage.getItem('groundingLastVisit');

  // Phases timing (ms)
  const phases = [
    { name: 'Inhale', duration: 4000 },
    { name: 'Hold', duration: 4000 },
    { name: 'Exhale', duration: 4000 },
    { name: 'Hold', duration: 4000 }
  ];

  // --- Functions ---

  // Save & load daily streak
  function updateDailyStreak() {
    const today = new Date().toDateString();
    if (!lastVisitDate) {
      dailyStreak = 1;
      localStorage.setItem('groundingLastVisit', today);
      localStorage.setItem('groundingDailyStreak', dailyStreak);
    } else {
      const lastDate = new Date(lastVisitDate);
      const diffDays = Math.floor((new Date(today) - lastDate) / (1000 * 60 * 60 * 24));
      if (diffDays === 1) {
        dailyStreak = (parseInt(localStorage.getItem('groundingDailyStreak')) || 0) + 1;
        localStorage.setItem('groundingDailyStreak', dailyStreak);
        localStorage.setItem('groundingLastVisit', today);
      } else if (diffDays > 1) {
        dailyStreak = 1;
        localStorage.setItem('groundingDailyStreak', dailyStreak);
        localStorage.setItem('groundingLastVisit', today);
      } else {
        dailyStreak = parseInt(localStorage.getItem('groundingDailyStreak')) || 1;
      }
    }
    document.getElementById('daily-streak').textContent = dailyStreak;
  }

  // Render techniques filtered by category and search
  function renderTechniques() {
    const searchTerm = searchInput.value.trim().toLowerCase();
    filteredTechniques = techniques.filter(t => {
      const matchCategory = currentCategory === 'all' || t.category === currentCategory;
      const matchSearch = t.title.toLowerCase().includes(searchTerm) || t.content.toLowerCase().includes(searchTerm);
      return matchCategory && matchSearch;
    });
    accordion.innerHTML = '';
    if(filteredTechniques.length === 0){
      accordion.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#888;">No techniques found.</p>`;
      document.getElementById('tech-count').textContent = '0';
      return;
    }
    filteredTechniques.forEach(t => {
      const btn = document.createElement('button');
      btn.className = 'card-button';
      btn.setAttribute('aria-haspopup', 'dialog');
      btn.setAttribute('aria-expanded', 'false');
      btn.type = 'button';
      btn.dataset.id = t.id;
      btn.innerHTML = `<span class="card-emoji" aria-hidden="true">${t.emoji}</span> ${t.title}`;
      btn.addEventListener('click', () => openModal(t));
      accordion.appendChild(btn);
    });
    document.getElementById('tech-count').textContent = filteredTechniques.length;
  }

  // Render checklist items for filtered techniques
  function renderChecklist() {
    checklist.innerHTML = '';
    filteredTechniques.forEach(t => {
      const div = document.createElement('div');
      div.className = 'checklist-item' + (checklistState[t.id] ? ' checked' : '');
      div.tabIndex = 0;
      div.role = 'checkbox';
      div.ariaChecked = checklistState[t.id] ? 'true' : 'false';
      div.textContent = t.title;
      div.addEventListener('click', () => toggleChecklistItem(t.id));
      div.addEventListener('keydown', e => {
        if(e.key === ' ' || e.key === 'Enter'){
          e.preventDefault();
          toggleChecklistItem(t.id);
        }
      });
      checklist.appendChild(div);
    });
  }

  // Toggle checklist item state
  function toggleChecklistItem(id) {
    checklistState[id] = !checklistState[id];
    localStorage.setItem('groundingChecklist', JSON.stringify(checklistState));
    renderChecklist();
  }

  // Update favorites count display
  function updateStats() {
    const favCount = Object.values(favorites).filter(Boolean).length;
    document.getElementById('favorites-count').textContent = favCount;
  }

  // Modal open
  function openModal(tech) {
    modalTitle.textContent = tech.title;
    modalEmoji.textContent = tech.emoji;
    modalCategory.textContent = `Category: ${capitalize(tech.category)}`;
    modalContent.innerHTML = tech.content;
    modalOverlay.classList.add('active');
    modalOverlay.removeAttribute('hidden');
    modalCloseBtn.focus();
    // Update aria-expanded on the button
    const btn = accordion.querySelector(`button[data-id="${tech.id}"]`);
    if(btn) btn.setAttribute('aria-expanded', 'true');
  }

  // Modal close
  function closeModal() {
    modalOverlay.classList.remove('active');
    modalOverlay.setAttribute('hidden', '');
    // Reset aria-expanded for all buttons
    accordion.querySelectorAll('button[aria-expanded="true"]').forEach(btn => {
      btn.setAttribute('aria-expanded', 'false');
    });
  }

  // Capitalize first letter helper
  function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  // Search input handler
  searchInput.addEventListener('input', () => {
    renderTechniques();
    renderChecklist();
  });

  // Category filter handlers
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-btn').forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-pressed', 'false');
      });
      btn.classList.add('active');
      btn.setAttribute('aria-pressed', 'true');
      currentCategory = btn.dataset.category;
      renderTechniques();
      renderChecklist();
    });
  });

  // Notes saving and loading
  notesTextarea.value = notes;
  notesTextarea.addEventListener('input', () => {
    localStorage.setItem('groundingNotes', notesTextarea.value);
  });

  // Breathing animation phases handler
  function startBreathing() {
    if (breathingRunning) return;
    breathingRunning = true;
    breathingPhase = 0;
    startBreathingBtn.disabled = true;
    stopBreathingBtn.disabled = false;
    runBreathingPhase();
  }
  function stopBreathing() {
    breathingRunning = false;
    clearTimeout(breathingInterval);
    breathCircle.textContent = 'Stopped';
    breathCircle.className = 'breath-circle';
    startBreathingBtn.disabled = false;
    stopBreathingBtn.disabled = true;
  }

  // Run each breathing phase sequentially with animation & sound
  function runBreathingPhase() {
    if (!breathingRunning) return;

    const phase = phases[breathingPhase];
    breathCircle.textContent = phase.name;

    // Reset classes & set according to phase for pulse animation
    breathCircle.className = 'breath-circle ' + (phase.name.toLowerCase());

    // Play sound on inhale/exhale
    if(phase.name.toLowerCase() === 'inhale'){
      breathSoundInhale.currentTime = 0;
      breathSoundInhale.play().catch(()=>{});
    }
    else if(phase.name.toLowerCase() === 'exhale'){
      breathSoundExhale.currentTime = 0;
      breathSoundExhale.play().catch(()=>{});
    }

    breathingInterval = setTimeout(() => {
      breathingPhase = (breathingPhase + 1) % phases.length;
      runBreathingPhase();
    }, phase.duration);
  }

  startBreathingBtn.addEventListener('click', startBreathing);
  stopBreathingBtn.addEventListener('click', stopBreathing);

  // Dark mode toggle
  function applyDarkMode(enabled) {
    if(enabled){
      document.body.classList.add('dark');
      toggleDarkMode.checked = true;
    } else {
      document.body.classList.remove('dark');
      toggleDarkMode.checked = false;
    }
    localStorage.setItem('groundingDarkMode', enabled ? 'true' : 'false');
  }
  toggleDarkMode.addEventListener('change', e => {
    applyDarkMode(e.target.checked);
  });
  // Load dark mode state
  applyDarkMode(localStorage.getItem('groundingDarkMode') === 'true');

  // Background music toggle
  function applyMusic(enabled) {
    if(enabled){
      bgMusic.play().catch(()=>{});
      toggleMusic.checked = true;
    } else {
      bgMusic.pause();
      toggleMusic.checked = false;
    }
    localStorage.setItem('groundingBgMusic', enabled ? 'true' : 'false');
  }
  toggleMusic.addEventListener('change', e => {
    applyMusic(e.target.checked);
  });
  // Load music state
  applyMusic(localStorage.getItem('groundingBgMusic') === 'true');

  // Download grounding guide PDF (simple text version)
  downloadPdfBtn.addEventListener('click', () => {
    let docContent = 'Grounding Techniques Guide\n\n';
    techniques.forEach(t => {
      docContent += `${t.emoji} ${t.title.toUpperCase()}\nCategory: ${capitalize(t.category)}\n\n${stripHtml(t.content)}\n\n---\n\n`;
    });

    const blob = new Blob([docContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Grounding_Techniques_Guide.txt';
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }, 0);
  });

  // Strip HTML tags helper
  function stripHtml(html) {
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || '';
  }

  // Add new technique prompt flow
  addTechBtn.addEventListener('click', () => {
    const title = prompt('Enter the technique title:').trim();
    if (!title) return alert('Title cannot be empty.');

    const category = prompt('Enter the category (physical, breathing, visualization, mindfulness, emotional, creative, emergency):').toLowerCase().trim();
    const validCategories = ['physical','breathing','visualization','mindfulness','emotional','creative','emergency'];
    if (!validCategories.includes(category)) return alert('Invalid category.');

    const emoji = prompt('Choose an emoji for the technique:').trim() || 'üßò';
    const content = prompt('Describe the technique:').trim() || '<p>No details provided.</p>';

    const id = `user-${Date.now()}`;
    techniques.push({ id, title, category, emoji, content });
    localStorage.setItem('groundingCustomTechniques', JSON.stringify(techniques.filter(t => t.id.startsWith('user-'))));
    renderTechniques();
    renderChecklist();
  });

  // Modal close handlers
  modalCloseBtn.addEventListener('click', closeModal);
  modalOverlay.addEventListener('click', e => {
    if(e.target === modalOverlay) closeModal();
  });
  window.addEventListener('keydown', e => {
    if(e.key === 'Escape') closeModal();
  });

  // Load custom techniques from localStorage
  const savedCustom = JSON.parse(localStorage.getItem('groundingCustomTechniques') || '[]');
  if(savedCustom.length){
    techniques.push(...savedCustom);
  }

  // Init
  renderTechniques();
  renderChecklist();
  updateStats();
  updateDailyStreak();
})();
</script>
</body>
</html>