<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>On 'Em ‚Äì Multi-Level & Boss</title>
  <style>
    body { margin: 0; overflow: hidden; }
    #gameCanvas { background: url('level1-wharf.png') repeat-x; display: block; }
    #touchControls { position: absolute; bottom: 20px; width: 100%; text-align: center; display: none; }
    .button { font-size: 2rem; padding: 10px; margin: 0 20px; opacity: 0.5; }
  </style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="400"></canvas>
<div id="touchControls">
  <button id="leftBtn" class="button">‚óÄÔ∏è</button>
  <button id="jumpBtn" class="button">ü¶ò</button>
  <button id="rightBtn" class="button">‚ñ∂Ô∏è</button>
</div>

<script>
// ‚Äî‚Äî‚Äî Asset Loader ‚Äî‚Äî‚Äî
const assets = {};
const files = [
  'fisher_walk1.png','fisher_walk2.png','fisher_jump.png',
  'lobster.png','boat1.png','level1-wharf.png',
  'level2-water.png','level3-storm.png','boss.png',
  'jump.wav','collect.wav','hit.wav','boss_hit.wav','victory.wav'
];
files.forEach(src => {
  if (src.endsWith('.png')) {
    const img = new Image(); img.src = src; assets[src] = img;
  } else {
    assets[src] = new Audio(src);
  }
});

// ‚Äî‚Äî‚Äî Canvas Setup ‚Äî‚Äî‚Äî
const c = document.getElementById('gameCanvas'), ctx = c.getContext('2d');
const W = c.width, H = c.height, groundY = 360;

// ‚Äî‚Äî‚Äî Game State ‚Äî‚Äî‚Äî
let level = 1, score = 0, health = 3, bossHealth = 5, inBoss = false;
const player = { x: 50,y: groundY-64,w:48,h:64,vx:0,vy:0,gravity:1,jumpPower:-15,onGround:true,frame:0,frameTick:0,speed:5 };
const keys = {};
document.addEventListener('keydown',e=>keys[e.code]=true);
document.addEventListener('keyup',e=>keys[e.code]=false);

// Mobile touch
if ('ontouchstart' in window) {
  document.getElementById('touchControls').style.display = 'block';
  let left=false,right=false,jump=false;
  ['leftBtn','rightBtn','jumpBtn'].forEach(id => {
    document.getElementById(id).addEventListener('touchstart',()=>{ if(id==='leftBtn') left=true; if(id==='rightBtn') right=true; if(id==='jumpBtn') jump=true; });
    document.getElementById(id).addEventListener('touchend',()=>{ if(id==='leftBtn') left=false; if(id==='rightBtn') right=false; if(id==='jumpBtn') jump=false; });
  });
  keys.TouchLeft = () => left;
  keys.TouchRight = () => right;
  keys.TouchJump = () => jump;
}

// ‚Äî‚Äî‚Äî Level Setup Function ‚Äî‚Äî‚Äî
function getLevelData(l) {
  if (l === 1) {
    return { bg:'level1-wharf.png', enemies: [{x:900,y:280,w:80,h:50,type:'boat'}], items:[{x:350,y:320,got:false},{x:600,y:320,got:false}] };
  } else if (l === 2) {
    return { bg:'level2-water.png', enemies: [{x:600,y:330,w:40,h:40,type:'jelly'}], items:[{x:300,y:300,got:false},{x:500,y:300,got:false}] };
  } else {
    inBoss = true;
    return { bg:'level3-storm.png', boss:{x:600,y:200,w:200,h:120}, items:[] };
  }
}
let levelData = getLevelData(1);

// ‚Äî‚Äî‚Äî Game Loop ‚Äî‚Äî‚Äî
function update() {
  // Movement
  const left = keys.ArrowLeft || keys.TouchLeft?.();
  const right = keys.ArrowRight || keys.TouchRight?.();
  player.vx = left ? -player.speed : right ? player.speed : 0;

  // Jump
  if ((keys.Space || keys.TouchJump?.()) && player.onGround) {
    player.vy = player.jumpPower; player.onGround = false; assets['jump.wav'].play();
  }
  // Physics
  player.x += player.vx;
  player.vy += player.gravity;
  player.y += player.vy;
  if (player.y + player.h >= groundY) { player.y = groundY - player.h; player.vy = 0; player.onGround = true; }

  // Animation
  player.frameTick++;
  if (player.frameTick % 10 === 0) player.frame = (player.frame + 1) % 2;

  // Collectibles
  levelData.items.forEach(item => {
    if (!item.got && player.x < item.x+20 && player.x+player.w > item.x &&
        player.y < item.y+20 && player.y+player.h > item.y) {
      item.got = true; score++; assets['collect.wav'].play();
    }
  });

  // Enemy or Boss Collisions
  if (!inBoss) {
    levelData.enemies.forEach(e => {
      if (player.x+player.w > e.x && player.x < e.x+e.w && player.y+player.h > e.y && player.y < e.y+e.h) {
        health--; player.x = 50; assets['hit.wav'].play();
      }
      // Move enemy
      e.x -= (e.type==='boat'?2:1);
      if(e.x < -e.w) e.x = W + Math.random()*200;
    });
  } else {
    // Boss battle
    const b = levelData.boss;
    if (player.x+player.w > b.x && player.x < b.x+b.w && player.y+player.h > b.y && player.y < b.y+b.h) {
      health--; player.x = 50; assets['hit.wav'].play();
    }
  }

  // Level progress
  if (!inBoss && player.x > W - player.w) {
    level++;
    levelData = getLevelData(level);
    player.x = 50;
  }

  // Boss fight shooting logic
  if (inBoss && keys.KeyC) {
    const b = levelData.boss;
    const dist = (player.x + player.w/2) - (b.x + b.w/2);
    if (Math.abs(dist) < 150) {
      bossHealth--; assets['boss_hit.wav'].play();
    }
    if (bossHealth === 0) {
      assets['victory.wav'].play();
      inBoss = false; level = 4;
    }
  }
}

function draw() {
  ctx.clearRect(0,0,W,H);
  ctx.drawImage(assets[levelData.bg], 0, 0, W, H);

  // Items
  levelData.items.forEach(item => {
    if (!item.got) ctx.drawImage(assets['lobster.png'], item.x, item.y, 32, 32);
  });

  // Enemies or boss
  if (!inBoss) {
    levelData.enemies.forEach(e => ctx.drawImage(assets[e.type==='boat'?'boat1.png':'boat1.png'], e.x, e.y, e.w, e.h));
  } else {
    const b = levelData.boss;
    ctx.drawImage(assets['boss.png'], b.x, b.y, b.w, b.h);
    ctx.fillStyle = 'red';
    ctx.fillRect(b.x, b.y-10, (bossHealth/5)*b.w, 5);
  }

  // Draw player
  const spr = player.onGround ? assets['fisher_walk'+(player.frame+1)+'.png'] : assets['fisher_jump.png'];
  ctx.drawImage(spr, player.x, player.y, player.w, player.h);

  // HUD
  ctx.fillStyle = 'white';
  ctx.font = '20px Arial';
  ctx.fillText(`Level: ${inBoss ? 'Boss' : level}`, 10, 30);
  ctx.fillText(`Lobsters: ${score}`, 10, 60);
  ctx.fillText(`Health: ${health}`, 10, 90);
}

function loop() {
  if (health <= 0) {
    ctx.fillStyle='rgba(0,0,0,0.7)';
    ctx.fillRect(0,0,W,H);
    ctx.fillStyle='white'; ctx.font='40px Arial';
    ctx.fillText('Game Over', W/2-100, H/2);
    return;
  }
  if (level === 4) {
    ctx.fillStyle='rgba(0,0,0,0.7)';
    ctx.fillRect(0,0,W,H);
    ctx.fillStyle='white'; ctx.font='30px Arial';
    ctx.fillText('Victory for Treaty Rights! üá≤üá¶‚öì', W/2-200, H/2);
    return;
  }
  update();
  draw();
  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>